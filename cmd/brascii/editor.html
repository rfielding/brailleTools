<!DOCTYPE html>
<html lang="en" dir="ltr">
  
<head>
    <meta charset="utf-8">
    <title>8-dot Braille Editor</title>
    <style>
        body {
          font-family: sans-serif;
        }

        @font-face {
          font-family: "orbitreader2";
          src: url("orbitreader2.woff") format('woff');
        }

        textarea {
            border: none;
            outline: none;
            spellcheck: false;
            padding: 1%;
            font-size: 1.5em;
            line-height: 1.0;
            font-family: orbitreader2;
        }

        brailleText {
            font-family: monospace;
            font-size: 2.5em;
            line-height: 1.0;
        }
    </style>
    <script>
      var escapeToggle = false;
      var dotsPressed = {};
      var dotsReleased = {};
      var byteMap = [
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
      ];
      var dots2byte = [
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
      ];

      var brailleAsciiPattern = [
        0b00000000, 0b00101110, 0b00010000, 0b00111100, 0b00101011, 0b00101001, 0b00101111, 0b00000100, 0b00110111, 0b00111110, 0b00100001, 0b00101100, 0b00100000, 0b00100100, 0b00101000, 0b00001100,
        0b00110100, 0b00000010, 0b00000110, 0b00010010, 0b00110010, 0b00100010, 0b00010110, 0b00110110, 0b00100110, 0b00010100, 0b00110001, 0b00110000, 0b00100011, 0b00111111, 0b00011100, 0b00111001,
        0b00001000, 0b00000001, 0b00000011, 0b00001001, 0b00011001, 0b00010001, 0b00001011, 0b00011011, 0b00010011, 0b00001010, 0b00011010, 0b00000101, 0b00000111, 0b00001101, 0b00011101, 0b00010101,
        0b00001111, 0b00011111, 0b00010111, 0b00001110, 0b00011110, 0b00100101, 0b00100111, 0b00111010, 0b00101101, 0b00111101, 0b00110101, 0b00101010, 0b00110011, 0b00111011, 0b00011000, 0b00111000,
      ];

      function byteMapInit() {
        var i = 0;
        // Start with standard 6-dot pattern
        for(i = 0x00; i < 0x40; i++) {
          byteMap[i+0x20] = brailleAsciiPattern[i];
        }
        // Copy bottom half down to control chars, and enable dot 7
        for(i = 0x20; i < 0x40; i++) {
          byteMap[i-0x20] = byteMap[i]+64;
        }
        // Copy top half up to lower case
        for(i = 0x40; i < 0x60; i++) {
          byteMap[i+0x20] = byteMap[i];
        }
        // Enable upper case on original top half
        for(i = 0x40; i < 0x60; i++) {
          byteMap[i] += 64;
        }
        // Copy whole map to top and set dot 8
        for(i = 0x00; i < 0x80; i++) {
          byteMap[i+0x80] = byteMap[i] + 128;
        }
        // Make reverse lookup map to find byte for given dots
        for(i = 0x00; i < 256; i++) {
          dots2byte[byteMap[i]] = i;
        }
      }

      document.onkeydown = function(e) {
        if(byteMap[0] == 0) {
          byteMapInit();
        }
        if(e.code == "Escape"){
          escapeToggle = !escapeToggle;
          if(escapeToggle) {
            document.getElementById("mode").innerText = "Perkins mode (ESC to toggle, chord 'asdf jkl;' keys for dots)";
          } else {
            document.getElementById("mode").innerText = "QWERTY mode (ESC to toggle)";
          }
          return false;
        }
        if(escapeToggle) {
          var isDot = false;
          if(e.code == "KeyF") { dotsPressed["1"] = 1; isDot = true;}
          if(e.code == "KeyD") { dotsPressed["2"] = 2; isDot = true;}
          if(e.code == "KeyS") { dotsPressed["3"] = 3; isDot = true;}
          if(e.code == "KeyA") { dotsPressed["7"] = 7; isDot = true;}
          if(e.code == "KeyJ") { dotsPressed["4"] = 4; isDot = true;}
          if(e.code == "KeyK") { dotsPressed["5"] = 5; isDot = true;}
          if(e.code == "KeyL") { dotsPressed["6"] = 6; isDot = true;}
          if(e.code == "Semicolon") { dotsPressed["8"] = 8; isDot = true;}
          if(!isDot) return true;
          return false;
        }
        return true;
      }

      document.onkeyup = function(e) {
        if(e.code == "Escape"){
          return false;
        }
        if(escapeToggle) {
          var isDot = false;
          if(e.code == "KeyF") { dotsReleased["1"] = 1; isDot = true;}
          if(e.code == "KeyD") { dotsReleased["2"] = 2; isDot = true;}
          if(e.code == "KeyS") { dotsReleased["3"] = 3; isDot = true;}
          if(e.code == "KeyA") { dotsReleased["7"] = 7; isDot = true;}
          if(e.code == "KeyJ") { dotsReleased["4"] = 4; isDot = true;}
          if(e.code == "KeyK") { dotsReleased["5"] = 5; isDot = true;}
          if(e.code == "KeyL") { dotsReleased["6"] = 6; isDot = true;}
          if(e.code == "Semicolon") { dotsReleased["8"] = 8; isDot = true;}
          if(isDot) {
            var LD = Object.keys(dotsPressed).length;
            var LU = Object.keys(dotsReleased).length;
            if(LD == LU) {
              var v = 0;
              for(i in dotsPressed) {
                var p = dotsPressed[i] - 1;
                v += Math.pow(2, p);
              }
              var c = String.fromCharCode(dots2byte[v]);
              dotsPressed = {};
              dotsReleased = {};
              var at = e.target.selectionStart;
              e.target.value =
                e.target.value.slice(0,at) + c + e.target.value.slice(at);
              document.getElementById("brailleText").innerText = e.target.value;
              e.target.selectionStart = at+1;
              e.target.selectionEnd = at+1;
              return false;
            } else {
              return false;
            }
          }
        }
        document.getElementById("brailleText").innerText = e.target.value;
        return true;
      }
    </script>
</head>
<body>
	<table>
              <tr>
		<td colspan=2>
                    <div id="mode">QWERTY mode (ESC to toggle)</div>
                </td>
              </tr>
              <tr>
                <td valign=top halign=left>
                    <textarea id="textarea1"
                              spellcheck=false 
                              class="input shadow" 
                              name="name" 
                              rows="26" 
                              cols="42"
                              autofocus
                              width="100%"></textarea>
                </td>
                <td valign=top halign=left>
                     <pre id="brailleText"></pre>
                </td>
              </tr>
</body>
  
</html>
